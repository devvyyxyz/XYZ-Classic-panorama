name: Auto-Update Minecraft Resource Pack

on:
  # Run daily at 3 AM UTC
  schedule:
    - cron: '0 3 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Modrinth Project ID (optional, uses env var if not provided)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  update-pack:
    runs-on: ubuntu-latest
    name: Update Resource Pack
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Resolve missing versions
        id: resolve
        env:
          PROJECT_ID: ${{ github.event.inputs.project_id || secrets.MODRINTH_PROJECT_ID }}
        run: |
          python3 scripts/resolve_versions.py "$PROJECT_ID" > /tmp/versions.json
          
          if [ $? -ne 0 ]; then
            echo "[!] Version resolution failed"
            exit 1
          fi
          
          # Store versions JSON as output (minified to single line)
          VERSIONS_JSON=$(cat /tmp/versions.json)
          echo "versions=$(echo "$VERSIONS_JSON" | jq -c .)" >> $GITHUB_OUTPUT
      
      - name: Extract groups to upload
        id: groups
        run: |
          python3 << 'EOF'
          import json
          import sys
          
          with open('/tmp/versions.json', 'r') as f:
              data = json.load(f)
          
          groups = data.get('groups_to_upload', [])
          
          if not groups:
              print("No pack format groups to upload - all up to date!")
              import os
              with open(os.environ.get('GITHUB_OUTPUT', '/tmp/output'), 'a') as f:
                  f.write("groups_count=0\n")
              sys.exit(0)
          
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"groups_count={len(groups)}\n")
              f.write(f"groups_json={json.dumps(groups)}\n")
          
          print(f"Found {len(groups)} pack format groups to upload")
          for group in groups:
              print(f"  - Pack Format {group['pack_format']}: {len(group['all_versions'])} versions ({group['version_range']})")
          EOF
      
      - name: Upload pack format groups
        if: steps.groups.outputs.groups_count != '0'
        env:
          MODRINTH_API_TOKEN: ${{ secrets.MODRINTH_API_TOKEN }}
          PROJECT_ID: ${{ github.event.inputs.project_id || secrets.MODRINTH_PROJECT_ID }}
          GROUPS_JSON: ${{ steps.groups.outputs.groups_json }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import sys
          import subprocess
          
          groups_json = os.environ.get('GROUPS_JSON', '[]')
          groups = json.loads(groups_json)
          modrinth_token = os.environ.get('MODRINTH_API_TOKEN')
          project_id = os.environ.get('PROJECT_ID')
          
          if not modrinth_token:
              print("ERROR: MODRINTH_API_TOKEN not set", file=sys.stderr)
              sys.exit(1)
          
          if not project_id:
              print("ERROR: MODRINTH_PROJECT_ID not set", file=sys.stderr)
              sys.exit(1)
          
          failed = []
          successful = []
          
          for group in groups:
              pack_format = group['pack_format']
              version_number = group['version_number']
              version_range = group['version_range']
              all_versions = group['all_versions']
              missing_versions = group['missing_versions']
              
              # Use first version in the group to update pack.mcmeta
              representative_version = all_versions[0]
              
              print(f"\n[*] Processing Pack Format {pack_format} ({version_range})...", file=sys.stderr)
              print(f"    Missing versions: {', '.join(missing_versions)}", file=sys.stderr)
              print(f"    Total versions in group: {len(all_versions)}", file=sys.stderr)
              
              # Update pack.mcmeta
              update_result = subprocess.run(
                  [
                      'python3', 'scripts/update_pack.py',
                      'pack.mcmeta',
                      representative_version,
                      str(pack_format),
                      'XYZ Classic Panorama'
                  ],
                  capture_output=True,
                  text=True
              )
              
              if update_result.returncode != 0:
                  print(f"[!] Failed to update pack.mcmeta for Pack Format {pack_format}", file=sys.stderr)
                  print(update_result.stderr, file=sys.stderr)
                  failed.append(version_number)
                  continue
              
              # Upload to Modrinth with all game versions
              game_versions_json = json.dumps(all_versions)
              upload_result = subprocess.run(
                  [
                      'python3', 'scripts/upload_modrinth.py',
                      project_id,
                      version_number,
                      game_versions_json,
                      modrinth_token,
                      '.'
                  ],
                  capture_output=True,
                  text=True
              )
              
              if upload_result.returncode != 0:
                  print(f"[!] Failed to upload Pack Format {pack_format} to Modrinth", file=sys.stderr)
                  print(upload_result.stderr, file=sys.stderr)
                  failed.append(version_number)
                  continue
              
              print(upload_result.stderr, file=sys.stderr)
              successful.append(f"{version_number} ({version_range})")
          
          print(f"\n[+] Summary:", file=sys.stderr)
          print(f"    Successful: {len(successful)}", file=sys.stderr)
          print(f"    Failed: {len(failed)}", file=sys.stderr)
          
          if failed:
              print(f"[!] Failed uploads: {', '.join(failed)}", file=sys.stderr)
              sys.exit(1)
          
          if successful:
              print(f"[+] Successfully uploaded:", file=sys.stderr)
              for item in successful:
                  print(f"      - {item}", file=sys.stderr)
          
          EOF
      
      - name: Summary
        if: always()
        run: |
          echo "## Resource Pack Update Report"
          echo ""
          echo "**Status**: ${{ job.status }}"
          echo "**Triggered by**: ${{ github.event_name }}"
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
